/*! ******************************************************************************
 *
 * Hop : The Hop Orchestration Platform
 *
 * Copyright (C) 2002-2017 by Hitachi Vantara : http://www.pentaho.com
 *
 *******************************************************************************
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 ******************************************************************************/
package org.apache.hop.core.plugins;

import org.apache.hop.core.exception.HopFileException;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import java.io.File;
import java.io.IOException;
import java.nio.file.FileVisitResult;
import java.nio.file.FileVisitor;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.BasicFileAttributes;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

/**
 * @author Tatsiana_Kasiankova
 */
public class PluginFolderTest {

  private static final String BASE_TEMP_DIR = System.getProperty( "java.io.tmpdir" );
  private static final String PLUGINS_DIR_NAME = "plugins";
  private static final String WITH_JAR_IN_NAME_DIR_NAME = "workflow.jar";
  private static final String TEST_DIR_NAME = "test_dir";
  /**
   *
   */
  private static final String JAR_FILE1_NAME = "workflow.jar";
  private static final String JAR_FILE2_NAME = "test.jar";
  /**
   *
   */
  private static final Path PATH_TO_JAR_IN_LIB_DIR = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, "lib", JAR_FILE2_NAME );
  private static final String NOT_JAR_FILE_NAME = "test.txt";
  private static final Path PATH_TO_PLUGIN_DIR = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME );
  /**
   * Paths below represent the following structure of the folder and files in them:
   * <p>
   * <TMP_DIR>/plugins/workflow.jar - folder
   * <p>
   * <TMP_DIR>/plugins/workflow.jar/workflow.jar - file
   * <p>
   * <TMP_DIR>/plugins/workflow.jar/test.txt - file
   */
  private static final Path PATH_TO_DIR_WITH_JAR_IN_NAME = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, WITH_JAR_IN_NAME_DIR_NAME );
  private static final Path PATH_TO_JAR_FILE1 = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, WITH_JAR_IN_NAME_DIR_NAME, JAR_FILE1_NAME );
  private static final Path PATH_TO_NOT_JAR_FILE = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, WITH_JAR_IN_NAME_DIR_NAME, NOT_JAR_FILE_NAME );

  /**
   * Paths below represent the following structure of the folder and files in them:
   * <p>
   * <TMP_DIR>/plugins/test_dir - folder
   * <p>
   * <TMP_DIR>/plugins/test_dir/workflow.jar - file
   * <p>
   * <TMP_DIR>/plugins/test_dir/test.txt - file
   */
  private static final Path PATH_TO_TEST_DIR_NAME = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, TEST_DIR_NAME );
  private static final Path PATH_TO_JAR_FILE2 = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, TEST_DIR_NAME, JAR_FILE2_NAME );
  private static final Path PATH_TO_NOT_JAR_FILE_IN_TEST_DIR = Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, TEST_DIR_NAME, NOT_JAR_FILE_NAME );

  private PluginFolder plFolder;

  @Before
  public void setUp() throws IOException {
    cleanTempDir( PATH_TO_PLUGIN_DIR );
    plFolder = new PluginFolder( PATH_TO_PLUGIN_DIR.toAbsolutePath().toString(), false, true );
  }

  @After
  public void clean() throws IOException {
    cleanTempDir( PATH_TO_PLUGIN_DIR );
    plFolder = null;
  }

  @Test
  public void testIsPluginXmlFolder_SetPluginXmlFolder() throws IOException, HopFileException {
    plFolder = new PluginFolder( PLUGINS_DIR_NAME, false, true );
    assertNotNull( plFolder );
    assertFalse( plFolder.isPluginXmlFolder() );
    plFolder.setPluginXmlFolder( true );
    assertTrue( plFolder.isPluginXmlFolder() );
    plFolder.setPluginXmlFolder( false );
    assertFalse( plFolder.isPluginXmlFolder() );
  }

  @Test
  public void testIsPluginAnnotationsFolder_SetPluginAnnotationsFolder() throws IOException, HopFileException {
    plFolder = new PluginFolder( PLUGINS_DIR_NAME, false, true );
    assertNotNull( plFolder );
    assertTrue( plFolder.isPluginAnnotationsFolder() );
    plFolder.setPluginAnnotationsFolder( false );
    assertFalse( plFolder.isPluginAnnotationsFolder() );
    plFolder.setPluginAnnotationsFolder( true );
    assertTrue( plFolder.isPluginAnnotationsFolder() );
  }

  @Test
  public void testGetFolder_SetFolder() throws IOException, HopFileException {
    plFolder = new PluginFolder( null, false, true );
    assertNotNull( plFolder );
    assertNull( plFolder.getFolder() );
    plFolder.setFolder( PLUGINS_DIR_NAME );
    assertEquals( PLUGINS_DIR_NAME, plFolder.getFolder() );
  }

  @Test
  public void testFindJarFiles_DirWithJarInNameNotAdded() throws IOException, HopFileException {
    Files.createDirectories( PATH_TO_DIR_WITH_JAR_IN_NAME );

    File[] findJarFiles = plFolder.findJarFiles();
    assertNotNull( findJarFiles );
    assertEquals( 0, findJarFiles.length );
  }

  @Test
  public void testFindJarFiles_DirWithJarInNameNotAddedButJarFileAdded() throws IOException, HopFileException {
    Files.createDirectories( PATH_TO_DIR_WITH_JAR_IN_NAME );
    Files.createFile( PATH_TO_JAR_FILE1 );

    File[] findJarFiles = plFolder.findJarFiles();
    assertNotNull( findJarFiles );
    assertEquals( 1, findJarFiles.length );
    assertTrue( findJarFiles[ 0 ].isFile() );
    assertEquals( PATH_TO_JAR_FILE1.toUri().toString(), findJarFiles[ 0 ].toPath().toUri().toString() );
  }

  @Test
  public void testFindJarFiles_DirWithJarInNameNotAddedAndTxtFileNotAdded() throws IOException, HopFileException {
    Files.createDirectories( PATH_TO_DIR_WITH_JAR_IN_NAME );
    Files.createFile( PATH_TO_NOT_JAR_FILE );

    File[] findJarFiles = plFolder.findJarFiles();
    assertNotNull( findJarFiles );
    assertEquals( 0, findJarFiles.length );
  }

  @Test
  public void testFindJarFiles_SeveralJarsInDifferentDirs() throws IOException, HopFileException {
    // Files in plugins/workflow.jar folder
    Files.createDirectories( PATH_TO_DIR_WITH_JAR_IN_NAME );
    Files.createFile( PATH_TO_JAR_FILE1 );
    Files.createFile( PATH_TO_NOT_JAR_FILE );
    // Files in plugins/test_dir folder
    Files.createDirectories( PATH_TO_TEST_DIR_NAME );
    Files.createFile( PATH_TO_JAR_FILE2 );
    Files.createFile( PATH_TO_NOT_JAR_FILE_IN_TEST_DIR );
    // Files in plugins folder
    Files.createFile( Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, JAR_FILE2_NAME ) );
    Files.createFile( Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, NOT_JAR_FILE_NAME ) );

    File[] findJarFiles = plFolder.findJarFiles();
    assertNotNull( findJarFiles );
    assertEquals( 3, findJarFiles.length );
  }

  @Test
  public void testFindJarFiles_LibDirIgnored() throws IOException, HopFileException {
    Files.createDirectories( Paths.get( BASE_TEMP_DIR, PLUGINS_DIR_NAME, "lib" ) );
    Files.createFile( PATH_TO_JAR_IN_LIB_DIR );

    File[] findJarFiles = plFolder.findJarFiles();
    assertNotNull( findJarFiles );
    assertEquals( 0, findJarFiles.length );
  }


  @Test
  public void testFindJarFiles_ExceptionThrows() {
    String nullFolder = null;
    String expectedMessage = "Unable to list jar files in plugin folder '" + nullFolder + "'";

    plFolder = new PluginFolder( nullFolder, false, true );
    try {
      plFolder.findJarFiles();
      fail( "HopFileException was not occured but expected." );
    } catch ( HopFileException e ) {
      assertTrue( e instanceof HopFileException );
      assertTrue( e.getLocalizedMessage().trim().startsWith( expectedMessage ) );
    }
  }

  private void cleanTempDir( Path path ) throws IOException {
    Files.walkFileTree( path, new FileVisitor<Path>() {
      @Override
      public FileVisitResult postVisitDirectory( Path dir, IOException exc ) throws IOException {
        Files.delete( dir );
        return FileVisitResult.CONTINUE;
      }

      @Override
      public FileVisitResult preVisitDirectory( Path dir, BasicFileAttributes attrs ) {
        return FileVisitResult.CONTINUE;
      }

      @Override
      public FileVisitResult visitFile( Path file, BasicFileAttributes attrs ) throws IOException {
        Files.delete( file );
        return FileVisitResult.CONTINUE;
      }

      @Override
      public FileVisitResult visitFileFailed( Path file, IOException exc ) throws IOException {
        return FileVisitResult.CONTINUE;
      }
    } );
  }

}
