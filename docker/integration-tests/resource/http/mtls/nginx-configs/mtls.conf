events {
    worker_connections 1024;
}

http {
    # Add JSON MIME type
    types {
        application/json json;
    }
    
    # mTLS endpoint (port 443)
    server {
        listen 443 ssl;
        server_name localhost;

        # Server certificate
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        
        # Client certificate verification
        ssl_client_certificate /etc/nginx/certs/ca.crt;
        ssl_verify_client on;
        ssl_verify_depth 2;
        
        # SSL protocols
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;

        # Basic test endpoint
        location /api/test {
            default_type application/json;
            return 200 '{"status":"success","message":"mTLS authentication successful","server":"hop-mtls-test","client":"$ssl_client_s_dn","serial":"$ssl_client_serial","verified":"$ssl_client_verify"}';
        }

        # Who am I endpoint - detailed certificate info
        location /api/whoami {
            default_type application/json;
            return 200 '{"authenticated":true,"client_dn":"$ssl_client_s_dn","issuer_dn":"$ssl_client_i_dn","serial":"$ssl_client_serial","verified":"$ssl_client_verify","fingerprint":"$ssl_client_fingerprint"}';
        }

        # Echo endpoint for all HTTP methods
        location /api/echo {
            default_type application/json;
            return 200 '{"method":"$request_method","uri":"$request_uri","client":"$ssl_client_s_dn","timestamp":"$time_iso8601"}';
        }

        # Error endpoint - returns 500
        location /api/error {
            default_type application/json;
            return 500 '{"error":"Internal Server Error","message":"This endpoint always returns 500"}';
        }

        # Health check
        location /health {
            default_type application/json;
            return 200 '{"status":"healthy","server":"hop-mtls-test"}';
        }
    }

    # Simple HTTP endpoint (no SSL, no authentication) - port 80
    server {
        listen 80;
        server_name localhost;

        location /api/test {
            default_type application/json;
            return 200 '{"status":"success","message":"Simple HTTP (no authentication)","server":"hop-simple"}';
        }

        location /health {
            default_type application/json;
            return 200 '{"status":"healthy","server":"hop-simple"}';
        }
    }
}
