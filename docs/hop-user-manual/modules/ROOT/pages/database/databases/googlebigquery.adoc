////
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
////
[[database-plugins-googlebigquery]]
:documentationPath: /database/databases/
:language: en_US
:openvar: ${
:closevar: }

= Google BigQuery

[cols="2*",options="header"]
|===
| Option | Info
|Type | Relational
|Driver | https://cloud.google.com/bigquery/docs/reference/odbc-jdbc-drivers[Driver Link]
|Version Included | None
|Hop Dependencies | None
|Documentation | https://www.simba.com/products/BigQuery/doc/JDBC_InstallGuide/content/jdbc/d-intro.htm[Documentation Link]
|JDBC Url | jdbc:bigquery://[Host]:[Port];ProjectId=[Project];OAuthType=[AuthValue]
|Driver folder | <Hop Installation>/lib/jdbc
|===

== Driver Installation

The Simba driver is packaged as a .zip containing many jars. Only a subset of the jars included with the Driver are necessary to use Bigquery JDBC with Apache Hop. Furthermore, some of the jars may conflict with those packaged with Hop and *must* be excluded.

**SIMBA DRIVER JARS TO EXCLUDE (THESE JARS ARE INCLUDED IN THE SIMBA DRIVER, BUT CONFLICT WITH HOP LIBRARIES AND MUST BE EXCLUDED**

 grpc-alts-<VERSION>.jar
 grpc-api-<VERSION>.jar  
 grpc-core-<VERSION>.jar
 grpc-netty-shaded-<VERSION>.jar

**SIMBA DRIVER JARS TO INCLUDE** (Include only these jars for a minimal Bigquery driver install):

 api-common-<VERSION>.jar
 gax-<VERSION>.jar
 gax-grpc-<VERSION>.jar
 google-api-services-bigquery-v2-<VERSION>.jar
 GoogleBigQueryJDBC42.jar
 google-cloud-bigquerystorage-<VERSION>.jar
 grpc-google-cloud-bigquerystorage-v1-<VERSION>.jar
 grpc-google-cloud-bigquerystorage-v1beta1-<VERSION>.jar
 grpc-google-cloud-bigquerystorage-v1beta2-<VERSION>.jar
 json-<VERSION>.jar
 proto-google-cloud-bigquerystorage-v1-<VERSION>.jar
 proto-google-cloud-bigquerystorage-v1beta1-<VERSION>.jar
 proto-google-cloud-bigquerystorage-v1beta2-<VERSION>.jar
 threetenbp-<VERSION>.jar

pass:[*] Tested with Hop 2.5.0 and Simba 1.3.3.1004. Not all authentication methods tested either, so this list may not be exhaustive

== Connection Configuration

=== Basic Connection Settings

When creating a Google BigQuery connection in Apache Hop, configure the following basic settings:

[cols="2*",options="header"]
|===
| Setting | Value
| Connection name | Your preferred connection name (e.g., "BQ")
| Connection type | Google BigQuery
| Access | Native (JDBC)
| Server host name | https://www.googleapis.com/bigquery/v2
| Database name | Your Google Cloud Project ID
| Port number | 443
|===

=== Authentication Options

Google BigQuery connections in Apache Hop support multiple authentication methods. The most common and recommended approach is using Service Account authentication with a JSON key file.

In the *Options* tab of the connection dialog, configure the following parameters:

[cols="3*",options="header"]
|===
| Parameter | Value | Description
| OAuthType | 0 | Service Account authentication
| ProjectId | your-project-id | Your Google Cloud Project ID
| OAuthServiceAcctEmail | service-account@your-project.iam.gserviceaccount.com | Service account email address
| OAuthPvtKeyPath | /path/to/service-account-key.json | Path to the service account JSON key file
| TimeOut | 3600 | Connection timeout in seconds (optional)
|===

=== Example Configuration

Here's a complete example of a working BigQuery connection configuration:

* **Connection name**: BQ
* **Server host name**: https://www.googleapis.com/bigquery/v2
* **Database name**: your-project-id
* **Port number**: 443

**Options tab parameters**:

* **OAuthType**: 0
* **ProjectId**: your-project-id
* **OAuthServiceAcctEmail**: your-service-account@your-project-id.iam.gserviceaccount.com
* **OAuthPvtKeyPath**: /path/to/your-service-account-key.json
* **TimeOut**: 3600

include::../../snippets/gcp-service-account-setup.adoc[]

== Testing the Connection

After configuring your connection:

1. Click the "Test" button in the connection dialog
2. If successful, you should see a confirmation message
3. If the test fails, verify:
   - Your service account has the necessary BigQuery permissions
   - The JSON key file path is correct and accessible
   - Your project ID matches the one in the service account
   - Network connectivity to Google APIs is available

== Troubleshooting

=== Common Issues

* **Authentication errors**: Verify that your service account has the required BigQuery roles and that the JSON key file path is correct
* **Project not found**: Ensure the ProjectId parameter matches your actual Google Cloud Project ID
* **Connection timeout**: Increase the TimeOut value if you're experiencing slow connections
* **Driver conflicts**: Ensure you've excluded the conflicting GRPC jars as listed in the driver installation section

=== Performance Considerations

* Use appropriate timeouts for large query operations
* Consider using BigQuery's standard SQL dialect for better performance
* Implement proper error handling in your workflows when working with large datasets
